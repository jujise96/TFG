@model List<ElementoUsuarioViewModel>

@{
    ViewData["Title"] = "Página de inicio";
    var tipo = ViewBag.tipoelemento as string;
    var idJuego = ViewBag.idJuego;
    if (Model != null && Model.Any())
    {
        idJuego = Model[0].idJuego;
    }
}

<div class="text-center card">
    <h1 class="display-4">Guía de Supervivencia del Yermo</h1>

    <div class="mb-3">
        @if ((tipo == "Mision" || tipo == "Item") && User.Identity.IsAuthenticated)
        {
            <button class="btn btn-outline-primary btn-sm m-1 filter-button active" data-filter="todos">Todos</button>
            <button class="btn btn-outline-success btn-sm m-1 filter-button" data-filter="completados">Completados</button>
            <button class="btn btn-outline-danger btn-sm m-1 filter-button" data-filter="no-completados">No Completados</button>

            <select id="subtipoFilter" class="form-select form-select-sm d-inline-block w-auto m-1">
                <option value="todos">Todos los @tipo</option>
                @if (tipo == "Mision")
                {
                    foreach (var val in Enum.GetValues(typeof(TipoQuest)))
                    {
                        <option value="@((int)val)">@(((TipoQuest)val).ToString())</option>
                    }
                }
                else if (tipo == "Item")
                {
                    foreach (var val in Enum.GetValues(typeof(TipoItem)))
                    {
                        <option value="@((int)val)">@(((TipoItem)val).ToString())</option>
                    }
                }
            </select>

        }
        @if (User.IsInRole("Admin"))
        {
            <form method="post" class="d-inline" asp-controller="Home" asp-action="CrearElemento" asp-route-tipo="@tipo" asp-route-idJuego="@idJuego">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-secondary m-1 btn-sm">Crear nuevo @tipo</button>
            </form>
        }
    </div>

    @if (Model != null && Model.Any())
    {
        <div class="mb-3 d-flex justify-content-center align-items-center">
            <input type="text" id="searchInput" class="form-control w-75" placeholder="Buscar por nombre...">
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover mt-3" id="elementTable">
                <thead>
                    <tr>
                        <th scope="col">Nombre</th>
                        @if (tipo == "Mision" || tipo == "Item")
                        {
                            <th scope="col">Tipo</th>
                        }
                        @if ((tipo == "Mision" || tipo == "Item") && User.Identity.IsAuthenticated)
                        {
                            <th scope="col">Completada</th>
                        }

                        @if (tipo == "Juego")
                        {
                            <th scope="col">Progreso</th>
                        }


                        @if (User.IsInRole("Admin"))
                        {
                            <th scope="col">Acciones</th>
                        }
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr class="elemento-lista data-subtipo" data-completada="@item.completada.ToString().ToLower()">
                            <td>
                                <a asp-controller="Home" asp-action="@tipo" asp-route-id="@item.Id" asp-route-idJuego="@item.idJuego">
                                    @item.Nombre
                                </a>
                            </td>
                            @if (tipo == "Mision")
                            {
                                <td>@(((TipoQuest)item.subtipo).ToString())</td>
                            }
                            else if (tipo == "Item")
                            {
                                <td>@(((TipoItem)item.subtipo).ToString())</td>
                            }

                            @if (tipo == "Juego")
                            {
                                <td>
                                    @if(item.Progreso >0){

                                        <div class="progress mt-2" role="progressbar" aria-label="Example with label" aria-valuenow="@item.Progreso" aria-valuemin="0" aria-valuemax="100">
                                            <div class="progress-bar" style="width: @item.Progreso%">@item.Progreso%</div>
                                        </div>

                                    }else{

                                        <p>¡Animate a empezar una partida!</p>

                                    }
                                </td>

                            }


                            @if ((tipo == "Mision" || tipo == "Item") && User.Identity.IsAuthenticated)
                            {
                                <td>
                                    <input type="checkbox" class="checkbox-completed" id="marcarcompletada_@item.Id" name="seleccionado_@item.Id" @(item.completada ? "checked" : "") />
                                </td>
                            }
                            @if (User.IsInRole("Admin"))
                            {
                                <td>
                                    <form method="post" asp-controller="Home" asp-action="eliminarelemento" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="tipo" value="@tipo" />
                                        <input type="hidden" name="idelemento" value="@item.Id" />
                                        <input type="hidden" name="idjuego" value="@item.idJuego" />
                                        <button type="submit" class="btn btn-outline-danger btn-sm m-0">Eliminar @tipo</button>
                                    </form>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
    else
    {
        <p>No hay elementos disponibles.</p>
    }
</div>

@section Scripts {
    <script>
        const urlaccion = '@Url.Action("MarcarCompletadaConModelo", "GestionUsuario")';
        const tipo = '@tipo';
        let marcarcompletada = document.querySelectorAll('.checkbox-completed');
        const filterButtons = document.querySelectorAll('.filter-button');
        const listaElementos = document.querySelectorAll('.elemento-lista');
        const searchInput = document.getElementById('searchInput'); // Get the new search input
        let filtroActivo = 'todos'; // Variable para almacenar el filtro activo
        let subtipoActivo = 'todos'; // Variable para almacenar el filtro de subtipo activo


        // Function to apply both completion and search filters
        function aplicarFiltro() {
            const searchTerm = searchInput.value.toLowerCase(); // Get the search term and convert to lowercase

            listaElementos.forEach(item => {
                const completada = item.getAttribute('data-completada');
                const itemSubtipo = item.getAttribute('data-subtipo'); // Obtener el subtipo del atributo data-*
                const itemName = item.querySelector('td').textContent.toLowerCase(); // Get the item name

                const matchesSearch = itemName.includes(searchTerm);
                let matchesCompletionFilter = true;
                let matchesSubtypeFilter = true; // Por defecto, coincide con el filtro de subtipo


                if (filtroActivo === 'completados') {
                    matchesCompletionFilter = (completada === 'true');
                } else if (filtroActivo === 'no-completados') {
                    matchesCompletionFilter = (completada === 'false');
                }

                // Lógica del filtro por subtipo
                if (subtipoActivo !== 'todos') {
                    // Comparamos el valor numérico del subtipo
                    matchesSubtypeFilter = (itemSubtipo === subtipoActivo);
                }

                // Show the row if it matches both the search and completion filters
                item.style.display = (matchesSearch && matchesCompletionFilter && matchesSubtypeFilter) ? 'table-row' : 'none';
            });
        }

        marcarcompletada.forEach(function (checkbox) {
            checkbox.addEventListener('change', async function () {
                const id = this.id.split('_')[1];
                const completada = this.checked;
                const listItem = this.closest('.elemento-lista');
                if (listItem) {
                    listItem.setAttribute('data-completada', completada.toString());
                }

                // Ensure an anti-forgery token is present if needed, for example, by adding a hidden input in your form.
                // For this example, I'm assuming you might have a hidden form with the token on your page.
                // If not, you might need to generate one or pass it differently based on your ASP.NET setup.
                const antiForgeryTokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
                const antiForgeryToken = antiForgeryTokenElement ? antiForgeryTokenElement.value : '';


                const respuesta = await fetch(urlaccion, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': antiForgeryToken // Send the token
                    },
                    body: JSON.stringify({
                        id: id,
                        tipo: tipo,
                        completada: completada
                    })
                });
                if (respuesta.ok) {
                    // Reapply the filter to update the view
                    aplicarFiltro();
                } else {
                    alert("Error al marcar el elemento.");
                }
            });
        });

        if (filterButtons.length > 0) {
            filterButtons.forEach(button => {
                button.addEventListener('click', function() {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    filtroActivo = this.getAttribute('data-filter');
                    aplicarFiltro();
                });
            });
        }

        if (subtipoFilterSelect) {
            subtipoFilterSelect.addEventListener('change', function() {
                subtipoActivo = this.value;
                aplicarFiltro();
            });
        }

        // Add event listener for the search input
        searchInput.addEventListener('keyup', aplicarFiltro);

        // On page load, apply the initial filter (All)
        aplicarFiltro();
    </script>
}