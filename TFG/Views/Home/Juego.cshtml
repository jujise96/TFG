@model Juego

@{
    ViewData["Title"] = Model.Nombre;
}

<div class="text-center">
    <h1 class="display-4">Bienvenido a @Model.Nombre</h1>
    <p>Consulta la información del juego y accede a sus contenidos.</p>
    @if (User.Identity.IsAuthenticated)
    {
        @if (User.IsInRole("Admin"))
        {
            <form method="post" asp-controller="Home" asp-action="ModificarElemento" asp-route-tipo="Juego" asp-route-idelemento=@Model.Id>
                <button type="submit" class="btn btn-outline-secondary btn-sm">Modificar juego: @Model.Nombre</button>
            </form>
        }
    }
</div>

<div class="container mt-4">
    <h2>Información del Juego</h2>
    <ul class="list-unstyled">
        <li><strong>Nombre:</strong> @Model.Nombre</li>
        <li><strong>IdElem:</strong> @Model.IdElem</li>
        <li><strong>Descripción:</strong> @Model.Descripcion</li>
    </ul>

    <h2>Secciones disponibles</h2>
    <ul class="list-unstyled">
        <li>
            <a asp-controller="Home" asp-action="Misiones" asp-route-id="@Model.Id">Ver Misiones</a>
        </li>
        <li>
            <a asp-controller="Home" asp-action="Items" asp-route-id="@Model.Id">Ver Ítems</a>
        </li>
        <li>
            <a asp-controller="Home" asp-action="Trucos" asp-route-id="@Model.Id">Ver Truco</a>
        </li>
    </ul>
</div>

<div id="seccion-de-comentarios">
    <p>Cargando comentarios...</p>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var tipoEntidad = "Juego";
            var entidadId = @Model.Id;
            var comentariosDiv = document.getElementById('seccion-de-comentarios');

            fetch(`/Comentario/MostrarComentarios?tipoEntidad=${tipoEntidad}&entidadId=${entidadId}`)
                .then(response => {
                    if (!response.ok) {
                        console.error('Error en la respuesta del servidor:', response.status, response.statusText);
                        comentariosDiv.innerHTML = '<p>Error al cargar los comentarios desde el servidor.</p>';
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(data => {
                    comentariosDiv.innerHTML = data;
                    // Ejecutar el script para adjuntar el event listener
                    var enviarBtn = comentariosDiv.querySelector('#formNuevoComentario button[type="button"]');
                    if (enviarBtn) {
                        enviarBtn.addEventListener('click', enviarComentario);
                    } else {
                        console.error('No se encontró el botón de enviar comentario después de la carga.');
                    }

                    function enviarComentario() {
                        var mensaje = document.getElementById('mensajeNuevoComentario').value;
                        var tipoEntidad = document.getElementById('tipoEntidad').value;
                        var entidadId = document.getElementById('entidadId').value;
                        var mensajeRespuesta = document.getElementById('mensajeRespuestaComentario');
                        var juegoId = document.getElementById('entidadId').value; // Obtén el Id del juego


                        if (mensaje.trim() === "") {
                            mensajeRespuesta.innerHTML = '<div class="alert alert-warning">Por favor, escribe un comentario.</div>';
                            return;
                        }

                        fetch('/Comentario/CrearComentario', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'RequestVerificationToken': '@Html.AntiForgeryToken()' // Importante para seguridad
                            },
                                body: `tipoEntidad=${tipoEntidad}&entidadId=${entidadId}&mensaje=${encodeURIComponent(mensaje)}&comentarioPadreId=&juegoId=${juegoId}` // Añade juegoId
        })
                        .then(response => {
                            if (response.ok) {
                                return response.text(); // Esperamos el HTML del nuevo comentario
                            } else {
                                console.error('Error al enviar el comentario:', response.status, response.statusText);
                                mensajeRespuesta.innerHTML = '<div class="alert alert-danger">Error al enviar el comentario. Inténtalo de nuevo.</div>';
                                throw new Error('Error al enviar el comentario.');
                            }
                        })
                        .then(data => {
                            // Insertar el nuevo comentario al principio de la lista
                            var comentariosContainer = document.querySelector('.card-body');
                            var nuevoComentarioDiv = document.createElement('div');
                            nuevoComentarioDiv.innerHTML = data;
                            comentariosContainer.insertBefore(nuevoComentarioDiv.firstChild, comentariosContainer.firstChild);

                            // Limpiar el textarea y mostrar un mensaje de éxito
                            document.getElementById('mensajeNuevoComentario').value = "";
                            mensajeRespuesta.innerHTML = '<div class="alert alert-success">Comentario enviado.</div>';
                            setTimeout(() => {
                                mensajeRespuesta.innerHTML = "";
                            }, 3000); // Limpiar el mensaje después de 3 segundos
                        })
                        .catch(error => {
                            console.error('Error:', error);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error de red al cargar los comentarios:', error);
                    comentariosDiv.innerHTML = '<p>Error de red al intentar cargar los comentarios.</p>';
                });
        });
    </script>
}